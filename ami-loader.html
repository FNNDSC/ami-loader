<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="ami-import.html">

<dom-module id="ami-loader">
  <script>
    Polymer({

      is: 'ami-loader',

      properties: {

        data: {
          type: Array,
          value: [],
          observer: '_dataChanged'
        },

        status: {
          type: Number,
          value: 0
        },

        progress: {
          type: Number,
          value: 0
        },

        loader: {
          type: Object,
          value: null
        },

        series: {
          type: Array,
          value: []
        }

      },

      _loadSequence: function( url ){

        // create the load sequence
        var self = this;

        return Promise.resolve()
        // fetch the file
        .then(function() {
          return self.loader.fetch(url);
        })
        // parse the file
        .then(function(data) {
          return self.loader.parse(data);
        })
        // update the series container
        .then(function(series) {
          self.series.push(series);
        })
        .catch(function(error) {
          window.console.log('oops... something went wrong...');
          window.console.log(error);
        });

      },

      _dataChanged: function( ){

        // prepare the load sequence for each file!
        if(!this.data){

          return;

        }

        this.loader = new AMI.default.Loaders.Volume();

        var loadSequences = [];
        var self = this;
        this.data.forEach(function(url) {
          loadSequences.push( self._loadSequence( url ) )
        });

        // fetch the data!
        Promise
          .all(loadSequences)
          .then(function() {
            // cleanup the loader
            self.loader.free();
            self.loader = null;

            // merge duplicate data if any
             self.series = self.series[0].mergeSeries(self.series);

             // emit series changed event!
             self.fire( 'series-changed' );
             self.fire( 'loaded' );
          });
      }

    });
  </script>
</dom-module>
